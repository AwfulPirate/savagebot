package org.alessio29.savagebot.r2.eval;

public class SwordWorldPowerRoller {
    private final Roller roller;

    public SwordWorldPowerRoller(Roller roller) {
        this.roller = roller;
    }

    public IntResult roll(int power, int critical) {
        if (power < 0 || power > MAX_POWER) {
            throw new EvaluationErrorException("Power out of range [0.." + MAX_POWER + "]: " + power);
        }

        if (critical > 0 && critical <= 5) {
            // Critical <= 0 means there's no critical.
            // Critical 1..2 would roll forever.
            // Critical 3..5 is not possible under core rules (and can potentially roll for a very long time).
            throw new EvaluationErrorException("Critical out of range: " + critical);
        }

        int total = 0;
        StringBuilder addends = new StringBuilder();

        while (true) {
            PowerTableRoll ptr = rollOnTable(power);
            if (ptr.value == -1) {
                addends.append("\\*");
                break;
            }

            total += ptr.value;
            addends.append(ptr.value);
            if (critical <= 0 || ptr.roll < critical) {
                break;
            } else {
                addends.append(" + ");
            }
        }

        StringBuilder explained = new StringBuilder();
        explained.append("(power ").append(power).append("; ");
        if (critical <= 0) {
            explained.append("no critical");
        } else {
            explained.append("critical ").append(critical);
        }
        explained.append(") ").append(addends);

        return new IntResult(total, explained.toString());
    }

    private static class PowerTableRoll {
        public final int roll;
        public final int value;

        public PowerTableRoll(int roll, int value) {
            this.roll = roll;
            this.value = value;
        }
    }

    private PowerTableRoll rollOnTable(int power) {
        int[] table = POWER_TABLE[power];
        int roll = roller.roll(6) + roller.roll(6);
        return new PowerTableRoll(roll, table[roll - 2]);
    }

    // Generated from tables in Sword World Core Rulebook III, '-1' stands for '*'
    private static final int[][] POWER_TABLE = new int[][]{
            {-1, 0, 0, 0, 1, 2, 2, 3, 3, 4, 4},
            // 1
            {-1, 0, 0, 0, 1, 2, 3, 3, 3, 4, 4},
            {-1, 0, 0, 0, 1, 2, 3, 4, 4, 4, 4},
            {-1, 0, 0, 1, 1, 2, 3, 4, 4, 4, 5},
            {-1, 0, 0, 1, 2, 2, 3, 4, 4, 5, 5},
            {-1, 0, 1, 1, 2, 2, 3, 4, 5, 5, 5},
            {-1, 0, 1, 1, 2, 3, 3, 4, 5, 5, 5},
            {-1, 0, 1, 1, 2, 3, 4, 4, 5, 5, 6},
            {-1, 0, 1, 2, 2, 3, 4, 4, 5, 6, 6},
            {-1, 0, 1, 2, 3, 3, 4, 4, 5, 6, 7},
            {-1, 1, 1, 2, 3, 3, 4, 5, 5, 6, 7},
            // 11
            {-1, 1, 2, 2, 3, 3, 4, 5, 6, 6, 7},
            {-1, 1, 2, 2, 3, 4, 4, 5, 6, 6, 7},
            {-1, 1, 2, 3, 3, 4, 4, 5, 6, 7, 7},
            {-1, 1, 2, 3, 4, 4, 4, 5, 6, 7, 8},
            {-1, 1, 2, 3, 4, 4, 5, 5, 6, 7, 8},
            {-1, 1, 2, 3, 4, 4, 5, 6, 7, 7, 8},
            {-1, 1, 2, 3, 4, 5, 5, 6, 7, 7, 8},
            {-1, 1, 2, 3, 4, 5, 6, 6, 7, 7, 8},
            {-1, 1, 2, 3, 4, 5, 6, 7, 7, 8, 9},
            {-1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10},
            // 21
            {-1, 1, 2, 3, 4, 6, 6, 7, 8, 9, 10},
            {-1, 1, 2, 3, 5, 6, 6, 7, 8, 9, 10},
            {-1, 2, 2, 3, 5, 6, 7, 7, 8, 9, 10},
            {-1, 2, 3, 4, 5, 6, 7, 7, 8, 9, 10},
            {-1, 2, 3, 4, 5, 6, 7, 8, 8, 9, 10},
            {-1, 2, 3, 4, 5, 6, 8, 8, 9, 9, 10},
            {-1, 2, 3, 4, 6, 6, 8, 8, 9, 9, 10},
            {-1, 2, 3, 4, 6, 6, 8, 9, 9, 10, 10},
            {-1, 2, 3, 4, 6, 7, 8, 9, 9, 10, 10},
            {-1, 2, 4, 4, 6, 7, 8, 9, 10, 10, 10},
            // 31
            {-1, 2, 4, 5, 6, 7, 8, 9, 10, 10, 11},
            {-1, 3, 4, 5, 6, 7, 8, 10, 10, 10, 11},
            {-1, 3, 4, 5, 6, 8, 8, 10, 10, 10, 11},
            {-1, 3, 4, 5, 6, 8, 9, 10, 10, 11, 11},
            {-1, 3, 4, 5, 7, 8, 9, 10, 10, 11, 12},
            {-1, 3, 5, 5, 7, 8, 9, 10, 11, 11, 12},
            {-1, 3, 5, 6, 7, 8, 9, 10, 11, 12, 12},
            {-1, 3, 5, 6, 7, 8, 10, 10, 11, 12, 13},
            {-1, 4, 5, 6, 7, 8, 10, 11, 11, 12, 13},
            {-1, 4, 5, 6, 7, 9, 10, 11, 11, 12, 13},
            // 41
            {-1, 4, 6, 6, 7, 9, 10, 11, 12, 12, 13},
            {-1, 4, 6, 7, 7, 9, 10, 11, 12, 13, 13},
            {-1, 4, 6, 7, 8, 9, 10, 11, 12, 13, 14},
            {-1, 4, 6, 7, 8, 10, 10, 11, 12, 13, 14},
            {-1, 4, 6, 7, 9, 10, 10, 11, 12, 13, 14},
            {-1, 4, 6, 7, 9, 10, 10, 12, 13, 13, 14},
            {-1, 4, 6, 7, 9, 10, 11, 12, 13, 13, 15},
            {-1, 4, 6, 7, 9, 10, 12, 12, 13, 13, 15},
            {-1, 4, 6, 7, 10, 10, 12, 12, 13, 14, 15},
            {-1, 4, 6, 8, 10, 10, 12, 12, 13, 15, 15},
            // 51
            {-1, 5, 7, 8, 10, 10, 12, 12, 13, 15, 15},
            {-1, 5, 7, 8, 10, 11, 12, 12, 13, 15, 15},
            {-1, 5, 7, 9, 10, 11, 12, 12, 14, 15, 15},
            {-1, 5, 7, 9, 10, 11, 12, 13, 14, 15, 16},
            {-1, 5, 7, 10, 10, 11, 12, 13, 14, 16, 16},
            {-1, 5, 8, 10, 10, 11, 12, 13, 15, 16, 16},
            {-1, 5, 8, 10, 11, 11, 12, 13, 15, 16, 17},
            {-1, 5, 8, 10, 11, 12, 12, 13, 15, 16, 17},
            {-1, 5, 9, 10, 11, 12, 12, 14, 15, 16, 17},
            {-1, 5, 9, 10, 11, 12, 13, 14, 15, 16, 18},
            // 61
            {-1, 5, 9, 10, 11, 12, 13, 14, 16, 17, 18},
            {-1, 5, 9, 10, 11, 13, 13, 14, 16, 17, 18},
            {-1, 5, 9, 10, 11, 13, 13, 15, 17, 17, 18},
            {-1, 5, 9, 10, 11, 13, 14, 15, 17, 17, 18},
            {-1, 5, 9, 10, 12, 13, 14, 15, 17, 18, 18},
            {-1, 5, 9, 10, 12, 13, 15, 15, 17, 18, 19},
            {-1, 5, 9, 10, 12, 13, 15, 16, 17, 19, 19},
            {-1, 5, 9, 10, 12, 14, 15, 16, 17, 19, 19},
            {-1, 5, 9, 10, 12, 14, 16, 16, 17, 19, 19},
            {-1, 5, 9, 10, 12, 14, 16, 17, 18, 19, 19},
            // 71
            {-1, 5, 9, 10, 13, 14, 16, 17, 18, 19, 20},
            {-1, 5, 9, 10, 13, 15, 16, 17, 18, 19, 20},
            {-1, 5, 9, 10, 13, 15, 16, 17, 19, 20, 21},
            {-1, 6, 9, 10, 13, 15, 16, 18, 19, 20, 21},
            {-1, 6, 9, 10, 13, 16, 16, 18, 19, 20, 21},
            {-1, 6, 9, 10, 13, 16, 17, 18, 19, 20, 21},
            {-1, 6, 9, 10, 13, 16, 17, 18, 20, 21, 22},
            {-1, 6, 9, 10, 13, 16, 17, 19, 20, 22, 23},
            {-1, 6, 9, 10, 13, 16, 18, 19, 20, 22, 23},
            {-1, 6, 9, 10, 13, 16, 18, 20, 21, 22, 23},
            // 81
            {-1, 6, 9, 10, 13, 17, 18, 20, 21, 22, 23},
            {-1, 6, 9, 10, 14, 17, 18, 20, 21, 22, 24},
            {-1, 6, 9, 11, 14, 17, 18, 20, 21, 23, 24},
            {-1, 6, 9, 11, 14, 17, 19, 20, 21, 23, 24},
            {-1, 6, 9, 11, 14, 17, 19, 21, 22, 23, 24},
            {-1, 7, 10, 11, 14, 17, 19, 21, 22, 23, 25},
            {-1, 7, 10, 12, 14, 17, 19, 21, 22, 24, 25},
            {-1, 7, 10, 12, 14, 18, 19, 21, 22, 24, 25},
            {-1, 7, 10, 12, 15, 18, 19, 21, 22, 24, 26},
            {-1, 7, 10, 12, 15, 18, 19, 21, 23, 25, 26},
            // 91
            {-1, 7, 11, 13, 15, 18, 19, 21, 23, 25, 26},
            {-1, 7, 11, 13, 15, 18, 20, 21, 23, 25, 27},
            {-1, 8, 11, 13, 15, 18, 20, 22, 23, 25, 27},
            {-1, 8, 11, 13, 16, 18, 20, 22, 23, 25, 28},
            {-1, 8, 11, 14, 16, 18, 20, 22, 23, 26, 28},
            {-1, 8, 11, 14, 16, 19, 20, 22, 24, 26, 28},
            {-1, 8, 12, 14, 16, 19, 20, 22, 24, 26, 28},
            {-1, 8, 12, 15, 16, 19, 20, 22, 24, 27, 28},
            {-1, 8, 12, 15, 17, 19, 20, 22, 24, 27, 29},
            {-1, 8, 12, 15, 18, 19, 20, 22, 24, 27, 30},
    };

    private static final int MAX_POWER = POWER_TABLE.length - 1;
}
